<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Use SparkKubernetesOperator on Airflow 1.10.x | Robby's Log</title>
<meta name=keywords content>
<meta name=description content="For many organizations, upgrading the Airflow installation to the newest version of 2.x is not an easy choice. Fortunately, the Airflow maintainer provides us with the backports. So, we can leverage them.
In our case, we need to use the new SparkKubernetesOperator which is available in the Airflow version 2.x. This operator provides us with the ability to launch a SparkApplication resource using the Spark On Kubernetes Operator. Our Airflow version was at 1.">
<meta name=author content>
<link rel=canonical href=https://mrobee.github.io/posts/use-sparkkubernetesoperator-on-airflow-1.10.x/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://mrobee.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://mrobee.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://mrobee.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://mrobee.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://mrobee.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.91.2">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HYYFPBCD8Y"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-HYYFPBCD8Y',{anonymize_ip:!1})}</script>
<meta property="og:title" content="Use SparkKubernetesOperator on Airflow 1.10.x">
<meta property="og:description" content="For many organizations, upgrading the Airflow installation to the newest version of 2.x is not an easy choice. Fortunately, the Airflow maintainer provides us with the backports. So, we can leverage them.
In our case, we need to use the new SparkKubernetesOperator which is available in the Airflow version 2.x. This operator provides us with the ability to launch a SparkApplication resource using the Spark On Kubernetes Operator. Our Airflow version was at 1.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://mrobee.github.io/posts/use-sparkkubernetesoperator-on-airflow-1.10.x/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-12-31T21:56:12+07:00">
<meta property="article:modified_time" content="2021-12-31T21:56:12+07:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Use SparkKubernetesOperator on Airflow 1.10.x">
<meta name=twitter:description content="For many organizations, upgrading the Airflow installation to the newest version of 2.x is not an easy choice. Fortunately, the Airflow maintainer provides us with the backports. So, we can leverage them.
In our case, we need to use the new SparkKubernetesOperator which is available in the Airflow version 2.x. This operator provides us with the ability to launch a SparkApplication resource using the Spark On Kubernetes Operator. Our Airflow version was at 1.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://mrobee.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Use SparkKubernetesOperator on Airflow 1.10.x","item":"https://mrobee.github.io/posts/use-sparkkubernetesoperator-on-airflow-1.10.x/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Use SparkKubernetesOperator on Airflow 1.10.x","name":"Use SparkKubernetesOperator on Airflow 1.10.x","description":"For many organizations, upgrading the Airflow installation to the newest version of 2.x is not an easy choice. Fortunately, the Airflow maintainer provides us with the backports. So, we can leverage them.\nIn our case, we need to use the new SparkKubernetesOperator which is available in the Airflow version 2.x. This operator provides us with the ability to launch a SparkApplication resource using the Spark On Kubernetes Operator. Our Airflow version was at 1.","keywords":[],"articleBody":"For many organizations, upgrading the Airflow installation to the newest version of 2.x is not an easy choice. Fortunately, the Airflow maintainer provides us with the backports. So, we can leverage them.\nIn our case, we need to use the new SparkKubernetesOperator which is available in the Airflow version 2.x. This operator provides us with the ability to launch a SparkApplication resource using the Spark On Kubernetes Operator. Our Airflow version was at 1.10.12 and we want to upgrade it to 1.10.15, the upgrade to this latest version went smooth without any problem. In theory, any Airflow 1.10.x can install the backport packages.\nThere’s a problem when we tried to use this operator. It needs a kubernetes_conn_id.\nCreate Kubernetes Connection To create the kubernetes connection in the Airflow, we can’t use the Airflow UI, since the kubernetes connection type doesn’t come up in the list.\nI tried to use the environment variable AIRFLOW_CONN_KUBERNETES_DEFAULT, it doesn’t work either.\nThe only way to create the connection is through the Airflow CLI. Since our Airflow cluster is already in the same cluster with the Spark On Kubernetes Operator, I use the in_cluster option to create the connection. You can refer to the documentation to choose which option is suitable for you.\nHere’s the Airflow CLI command to create the connection.\nairflow connections add --conn-extra='{\"extra__kubernetes__in_cluster\":true,\"extra__kubernetes__namespace\":\"the-default-namespace-to-use\"}' --conn-host='' --conn-type=kubernetes kubernetes_default Basically, we need to provide the --conn-type=kubernetes, --conn-host='', the connection ID, and the connection extras. If you decide to use other options, you need to provide that option in the extras.\nTo use the kube config path, provide the extras with\n{ \"extra__kubernetes__kube_config_path\": \"path_to_kube_config\" } Or if you want, you can pass the content of the kube config directly in the extras\n{ \"extra__kubernetes__kube_config\": \"content_of_kube_config_in_json_format\" } This configuration is extracted from the source code.\nThat’s it! Now we’re ready to use the SparkKubernetesOperator.\n","wordCount":"307","inLanguage":"en","datePublished":"2021-12-31T21:56:12+07:00","dateModified":"2021-12-31T21:56:12+07:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mrobee.github.io/posts/use-sparkkubernetesoperator-on-airflow-1.10.x/"},"publisher":{"@type":"Organization","name":"Robby's Log","logo":{"@type":"ImageObject","url":"https://mrobee.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://mrobee.github.io/ accesskey=h title="Robby's Log (Alt + H)">Robby's Log</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Use SparkKubernetesOperator on Airflow 1.10.x
</h1>
<div class=post-meta><span title="2021-12-31 21:56:12 +0700 +0700">December 31, 2021</span>
</div>
</header>
<div class=post-content><p>For many organizations, upgrading the Airflow installation to the newest version of 2.x is not an easy choice. Fortunately, the Airflow maintainer provides us with the backports. So, we can leverage them.</p>
<p>In our case, we need to use the new <a href=https://airflow.apache.org/docs/apache-airflow-providers-cncf-kubernetes/stable/_api/airflow/providers/cncf/kubernetes/operators/spark_kubernetes/index.html>SparkKubernetesOperator</a> which is available in the Airflow version 2.x. This operator provides us with the ability to launch a SparkApplication resource using the <a href=https://github.com/GoogleCloudPlatform/spark-on-k8s-operator>Spark On Kubernetes Operator</a>. Our Airflow version was at 1.10.12 and we want to upgrade it to 1.10.15, the upgrade to this latest version went smooth without any problem. In theory, any Airflow 1.10.x can install the backport packages.</p>
<p>There&rsquo;s a problem when we tried to use this operator. It needs a <code>kubernetes_conn_id</code>.</p>
<h3 id=create-kubernetes-connection>Create Kubernetes Connection<a hidden class=anchor aria-hidden=true href=#create-kubernetes-connection>#</a></h3>
<p>To create the kubernetes connection in the Airflow, we can&rsquo;t use the Airflow UI, since the <code>kubernetes</code> connection type doesn&rsquo;t come up in the list.</p>
<p>I tried to use the environment variable <code>AIRFLOW_CONN_KUBERNETES_DEFAULT</code>, it doesn&rsquo;t work either.</p>
<p>The only way to create the connection is through the Airflow CLI. Since our Airflow cluster is already in the same cluster with the <a href=https://github.com/GoogleCloudPlatform/spark-on-k8s-operator>Spark On Kubernetes Operator</a>, I use the <code>in_cluster</code> option to create the connection. You can refer to the <a href=https://airflow.apache.org/docs/apache-airflow-providers-cncf-kubernetes/stable/connections/kubernetes.html>documentation</a> to choose which option is suitable for you.</p>
<p>Here&rsquo;s the Airflow CLI command to create the connection.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>airflow connections add --conn-extra<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{&#34;extra__kubernetes__in_cluster&#34;:true,&#34;extra__kubernetes__namespace&#34;:&#34;the-default-namespace-to-use&#34;}&#39;</span> --conn-host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span> --conn-type<span style=color:#f92672>=</span>kubernetes kubernetes_default
</code></pre></div><p>Basically, we need to provide the <code>--conn-type=kubernetes</code>, <code>--conn-host=''</code>, the connection ID, and the connection extras. If you decide to use other options, you need to provide that option in the extras.</p>
<p>To use the kube config path, provide the extras with</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{ <span style=color:#f92672>&#34;extra__kubernetes__kube_config_path&#34;</span>: <span style=color:#e6db74>&#34;path_to_kube_config&#34;</span> }
</code></pre></div><p>Or if you want, you can pass the content of the kube config directly in the extras</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{ <span style=color:#f92672>&#34;extra__kubernetes__kube_config&#34;</span>: <span style=color:#e6db74>&#34;content_of_kube_config_in_json_format&#34;</span> }
</code></pre></div><p>This configuration is extracted from the <a href=https://github.com/apache/airflow/blob/main/airflow/providers/cncf/kubernetes/hooks/kubernetes.py>source code</a>.</p>
<p>That&rsquo;s it! Now we&rsquo;re ready to use the SparkKubernetesOperator.</p>
</div>
<footer class=post-footer>
</footer><div id=disqus_thread></div>
<script>(function(){var a=document,b=a.createElement('script');b.src='https://mrobee-github-io.disqus.com/embed.js',b.setAttribute('data-timestamp',+new Date),(a.head||a.body).appendChild(b)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://mrobee.github.io/>Robby's Log</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>